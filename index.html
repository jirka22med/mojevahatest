<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokroƒçil√Ω v√°hov√Ω tracker v√≠ce admir√°la Ji≈ô√≠ka</title>
    <!-- V≈°echny extern√≠ skripty nech√°v√°me v head, ale teƒè u≈æ je to na tom, ≈æe n√°≈° hlavn√≠ script bude a≈æ na konci body -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Opraveno: z 'ssrc' na 'src' -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background: #0d1117;
            color: #f0f0f0;
            font-family: Consolas, monospace;
            padding: 20px;
            margin: 0;
            text-align: center;
        }

        .container {
            max-width: 1350px;
            margin: 0 auto;
        }

        h1, h2 {
            color: #00d9ff;
            text-align: center;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .card {
            background: #1f2633;
            border: 1px solid #444;
            border-radius: 10px;
            padding: 20px;
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            border-color: #00d9ff;
        }

        .card h3 {
            color: #00ff99;
            margin-top: 0;
        }

        .form-group {
            margin: 15px 0;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #00d9ff;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            background: #0d1117;
            border: 1px solid #444;
            color: #f0f0f0;
            border-radius: 5px;
            box-sizing: border-box;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #00d9ff;
            outline: none;
        }

        button {
            background: #00d9ff;
            color: #000;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: background 0.3s;
        }

        button:hover {
            background: #00b8cc;
        }

        button.danger {
            background: #ff5555;
            color: #fff;
        }

        button.success {
            background: #55ff99;
            color: #000;
        }

        button.fullscreen {
            background: #00d9ff;
            color: #000;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            font-size: 1.2rem;
        }

        button.fullscreen:hover {
            background: #00b8cc;
            transform: scale(1.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #1f2633;
            font-size: 0.9em;
        }

        th, td {
            border: 1px solid #444;
            padding: 8px;
            text-align: center;
        }

        th {
            background: #0d1117;
            color: #00d9ff;
        }

        .gain {
            color: #ff5555;
        }

        .loss {
            color: #55ff99;
        }

        .bmi-normal { color: #55ff99; }
        .bmi-underweight { color: #00d9ff; }
        .bmi-overweight { color: #ffff55; }
        .bmi-obese { color: #ff5555; }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            background: #ff5555;
            color: #fff;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .stat-item {
            background: #1f2633;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #444;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #00d9ff;
        }
        .stat-label {
            font-size: 0.8em;
            color: #ccc;
            margin-top: 3px;
        }


        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00d9ff;
            color: #000;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #444;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d9ff, #00ff99);
            transition: width 0.3s;
        }

        .tabs {
            display: flex;
            margin: 20px 0;
            border-bottom: 1px solid #444;
            flex-wrap: wrap; /* Pro responzivitu */
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #ccc;
        }

        .tab.active {
            color: #00d9ff;
            border-bottom-color: #00d9ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
            background-color: #1a222d;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .chart-card {
            background-color: #1f2633;
            border-radius: 10px;
            padding: 20px;
            box-shadow: none;
            border: 1px solid #444;
            transition: transform 0.3s ease, border-color 0.3s ease;
            overflow-x: auto;
        }
        .chart-card:hover {
            transform: translateY(-5px);
            border-color: #00d9ff;
        }

        .chart-card h3 {
            margin-bottom: 15px;
            font-size: 1.2rem;
            color: #00ff99;
            text-align: center;
        }

        .chart-card canvas {
            width: 100% !important;
            height: auto !important;
            max-height: 200px;
        }

        /* Custom Confirmation Modal */
        #customConfirmModal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s ease-out;
        }

        #customConfirmModal > div {
            background-color: #1f2633;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #00d9ff;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease-out;
        }

        #customConfirmModal p {
            color: #f0f0f0;
            margin-bottom: 20px;
            font-size: 1.1em;
        }

        #customConfirmModal button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        #customConfirmModal button#confirmYes {
            background-color: #55ff99;
            color: #000;
        }
        #customConfirmModal button#confirmYes:hover {
            background-color: #44cc88;
            transform: scale(1.05);
        }

        #customConfirmModal button#confirmNo {
            background-color: #ff5555;
            color: #fff;
        }
        #customConfirmModal button#confirmNo:hover {
            background-color: #cc4444;
            transform: scale(1.05);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }


        @media (max-width: 768px) {
            .stats {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
            table {
                font-size: 0.75rem;
            }
            th, td {
                padding: 4px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            h1, h2 {
                font-size: 1.5rem;
            }
            .dashboard {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .card {
                padding: 15px;
            }
            .charts-container {
                grid-template-columns: 1fr;
            }
            .chart-card {
                padding: 15px;
                overflow-x: auto;
            }
            .stats {
                grid-template-columns: 1fr 1fr;
            }
            .stat-item {
                padding: 8px;
            }
            .stat-value {
                font-size: 1.2em;
            }
            .stat-label {
                font-size: 0.7em;
            }
            .notification {
                width: 80%;
                left: 10%;
                right: 10%;
            }
            .tabs {
                flex-direction: column;
                border-bottom: none;
            }
            .tab {
                border-bottom: 1px solid #444;
                padding: 8px 15px;
            }
            .tab.active {
                border-left: 3px solid #00d9ff;
                border-bottom: 1px solid #444;
            }
            button {
                padding: 8px 15px;
                width: 100%;
                margin: 5px 0;
            }
            button.fullscreen {
                width: 40px !important;
                height: 40px !important;
                bottom: 10px !important;
                right: 10px !important;
            }
            table {
                font-size: 0.65rem;
                display: block;
                overflow-x: auto;
            }
            th, td {
                padding: 3px;
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üññ Pokroƒçil√Ω v√°hov√Ω tracker v√≠ce admir√°la Ji≈ô√≠ka</h1>

        <div class="notification" id="notification"></div>
        <div class="alert" id="bmiAlert"></div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('dashboard')">Dashboard</div>
            <div class="tab" onclick="showTab('add-entry')">Nov√Ω z√°znam</div>
            <div class="tab" onclick="showTab('goals')">C√≠le</div>
            <div class="tab" onclick="showTab('settings')">Nastaven√≠</div>
            <div class="tab" onclick="showTab('export')">Export/Import</div>
            <button onclick="refreshAllData()" style="background-color: #6633cc; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; margin-top: 10px;">
                Aktualizovat V≈°echny √ödaje (vƒç. Supabase)
            </button>
        </div>

        <div id="dashboard" class="tab-content active">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="currentWeight">-</div>
                    <div class="stat-label">Aktu√°ln√≠ v√°ha (kg)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="currentBMI">-</div>
                    <div class="stat-label">Aktu√°ln√≠ BMI</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="weightChange">-</div>
                    <div class="stat-label">Zmƒõna v√°hy (kg)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="currentBodyWater">-</div>
                    <div class="stat-label">Voda v tƒõle (%)</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="lastManualBMR">-</div>
                    <div class="stat-label">Posl. zadan√Ω BMR</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="lastManualAMR">-</div>
                    <div class="stat-label">Posl. zadan√Ω AMR</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="theoreticalBMR">-</div>
                    <div class="stat-label">Teoretick√Ω BMR</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="theoreticalAMR">-</div>
                    <div class="stat-label">Teoretick√Ω AMR</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="goalProgress">-</div>
                    <div class="stat-label">Pokrok k c√≠li (%)</div>
                </div>
            </div>

            <div id="goalProgressBarCard" class="card" style="display:none; margin-bottom: 20px;">
                <h3>Pokrok k c√≠li</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="goalStatus" style="text-align: center; margin-top: 10px; color: #00d9ff;"></div>
                <div id="goalEstimate" class="stat-subtext" style="text-align: center; margin-top: 5px; color: #ccc;">Odhad: ...</div>
                <div id="latestEntryDate" style="text-align: center; margin-top: 5px; font-size: 0.9em; color: #aaa;"></div>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <h3>V√Ωvoj v√°hy</h3>
                    <canvas id="weightChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>V√Ωvoj BMI</h3>
                    <canvas id="bmiChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>V√Ωvoj tƒõlesn√©ho tuku (%)</h3>
                    <canvas id="bodyFatOnlyChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>V√Ωvoj svalov√© hmoty (%)</h3> <canvas id="muscleMassOnlyChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>V√Ωvoj vody v tƒõle</h3>
                    <canvas id="bodyWaterChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>V√Ωvoj zadan√©ho BMR (kcal)</h3>
                    <canvas id="manualBMRChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>V√Ωvoj zadan√©ho AMR (kcal)</h3>
                    <canvas id="manualAMRChart"></canvas>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Datum</th>
                        <th>V√°ha</th>
                        <th>Rozd√≠l</th>
                        <th>BMI</th>
                        <th>Klasif.</th>
                        <th>Tuk%</th>
                        <th>Svaly (%)</th>
                        <th>Voda%</th>
                        <th>Zad. BMR</th>
                        <th>Zad. AMR</th>
                        <th>Pozn.</th>
                        <th>Akce</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div id="add-entry" class="tab-content">
            <div class="card">
                <h3>P≈ôidat nov√Ω z√°znam</h3>
                <form id="entryForm">
                    <div class="form-group">
                        <label for="entryDate">Datum:</label>
                        <input type="date" id="entryDate" required>
                    </div>
                    <div class="form-group">
                        <label for="entryWeight">V√°ha (kg):</label>
                        <input type="number" id="entryWeight" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label for="entryBodyFat">Tƒõlesn√Ω tuk (%):</label>
                        <input type="number" id="entryBodyFat" step="0.1" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="entryMuscleMass">Svalov√° hmota (kg):</label>
                        <input type="number" id="entryMuscleMass" step="0.1" min="0">
                    </div>
                    <div class="form-group">
                        <label for="entryBodyWater">Voda v tƒõle (%):</label>
                        <input type="number" id="entryBodyWater" step="0.1" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="entryManualBMR">Ruƒçnƒõ zadan√© BMR (kcal):</label>
                        <input type="number" id="entryManualBMR" step="1" min="0">
                    </div>
                    <div class="form-group">
                        <label for="entryManualAMR">Ruƒçnƒõ zadan√© AMR (kcal):</label>
                        <input type="number" id="entryManualAMR" step="1" min="0">
                    </div>
                    <div class="form-group">
                        <label for="entryNotes">Pozn√°mky:</label>
                        <textarea id="entryNotes" rows="3"></textarea>
                    </div>
                    <button type="submit">P≈ôidat z√°znam</button>
                </form>
            </div>
        </div>

        <div id="goals" class="tab-content">
            <div class="card">
                <h3>Nastaven√≠ c√≠l≈Ø</h3>
                <form id="goalsForm">
                    <div class="form-group">
                        <label for="targetWeight">C√≠lov√° v√°ha (kg):</label>
                        <input type="number" id="targetWeight" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="targetBMI">C√≠lov√© BMI:</label>
                        <input type="number" id="targetBMI" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="targetDate">Term√≠n splnƒõn√≠ c√≠le:</label>
                        <input type="date" id="targetDate">
                    </div>
                    <div class="form-group">
                        <label for="weeklyGoal">T√Ωdenn√≠ zmƒõna v√°hy (kg) (nap≈ô. -0.5 pro hubnut√≠):</label>
                        <input type="number" id="weeklyGoal" step="0.1">
                    </div>
                    <button type="submit">Ulo≈æit c√≠le</button>
                </form>

                <div id="recommendations" class="card" style="margin-top: 20px; background: #2a3441;">
                    <h3>Doporuƒçen√≠</h3>
                    <div id="recommendationText"></div>
                </div>
            </div>
        </div>

        <div id="settings" class="tab-content">
            <div class="dashboard">
                <div class="card">
                    <h3>Osobn√≠ √∫daje (pro teoretick√© v√Ωpoƒçty)</h3>
                    <form id="settingsForm">
                        <div class="form-group">
                            <label for="height">V√Ω≈°ka (cm):</label>
                            <input type="number" id="height" min="100" max="250" value="174">
                        </div>
                        <div class="form-group">
                            <label for="age">Vƒõk:</label>
                            <input type="number" id="age" min="1" max="120">
                        </div>
                        <div class="form-group">
                            <label for="gender">Pohlav√≠:</label>
                            <select id="gender">
                                <option value="male">Mu≈æ</option>
                                <option value="female">≈Ωena</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="activityLevel">√örove≈à fyzick√© aktivity:</label>
                            <select id="activityLevel">
                                <option value="1.2">Sedav√© (m√°lo nebo ≈æ√°dn√© cviƒçen√≠)</option>
                                <option value="1.375">Lehce aktivn√≠ (cviƒçen√≠ 1-3 dny/t√Ωden)</option>
                                <option value="1.55">M√≠rnƒõ aktivn√≠ (cviƒçen√≠ 3-5 dn√≠/t√Ωden)</option>
                                <option value="1.725">Velmi aktivn√≠ (cviƒçen√≠ 6-7 dn√≠/t√Ωden)</option>
                                <option value="1.9">Extr√©mnƒõ aktivn√≠ (velmi tƒõ≈æk√© cviƒçen√≠, fyzick√° pr√°ce)</option>
                            </select>
                        </div>
                        <button type="submit">Ulo≈æit nastaven√≠</button>
                    </form>
                </div>

                <div class="card">
                    <h3>BMI hranice</h3>
                    <form id="bmiAlertsForm">
                        <div class="form-group">
                            <label for="bmiWarningUpper">Horn√≠ hranice BMI (varov√°n√≠):</label>
                            <input type="number" id="bmiWarningUpper" step="0.1" value="25">
                        </div>
                        <div class="form-group">
                            <label for="bmiDangerUpper">Horn√≠ hranice BMI (nebezpeƒç√≠):</label>
                            <input type="number" id="bmiDangerUpper" step="0.1" value="30">
                        </div>
                        <div class="form-group">
                            <label for="bmiWarningLower">Doln√≠ hranice BMI (varov√°n√≠):</label>
                            <input type="number" id="bmiWarningLower" step="0.1" value="18.5">
                        </div>
                        <button type="submit">Ulo≈æit hranice</button>
                    </form>
                </div>

                <div class="card">
                    <h3>P≈ôipom√≠nky</h3>
                    <form id="remindersForm">
                        <div class="form-group">
                            <label for="reminderEnabled">Povolit p≈ôipom√≠nky:</label>
                            <input type="checkbox" id="reminderEnabled" style="width: auto;">
                        </div>
                        <div class="form-group">
                            <label for="reminderInterval">Interval p≈ôipom√≠nek (dny):</label>
                            <input type="number" id="reminderInterval" min="1" max="30" value="7">
                        </div>
                        <button type="submit">Ulo≈æit p≈ôipom√≠nky</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="export" class="tab-content">
            <div class="dashboard">
                <div class="card">
                    <h3>Export dat</h3>
                    <button onclick="exportToCSV()">üìä Export do CSV</button>
                    <button onclick="exportToPDF()">üìÑ Export do PDF</button>
                    <button onclick="exportChartsAsPDF()">üìà Export graf≈Ø do PDF</button>
                    <button onclick="exportBackup()">üíæ √öpln√° z√°loha</button>
                </div>

                <div class="card">
                    <h3>Import dat</h3>
                    <div class="form-group">
                        <label for="csvImport">Import CSV:</label>
                        <input type="file" id="csvImport" accept=".csv" onchange="importFromCSV(this)">
                    </div>
                    <div class="form-group">
                        <label for="backupImport">Obnovit ze z√°lohy:</label>
                        <input type="file" id="backupImport" accept=".json" onchange="importFromBackup(this)">
                    </div>
                    <button class="danger" onclick="clearAllData()">üóëÔ∏è Vymazat v≈°echna data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal HTML -->
    <div id="customConfirmModal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7);">
      <div style="background-color: #1f2633; margin: 15% auto; padding: 20px; border: 1px solid #00d9ff; border-radius: 10px; width: 90%; max-width: 400px; text-align: center;">
        <p id="confirmMessage" style="color: #f0f0f0; margin-bottom: 20px;"></p>
        <button id="confirmYes" style="background-color: #55ff99; color: #000; margin-right: 10px;">Ano</button>
        <button id="confirmNo" style="background-color: #ff5555; color: #fff;">Ne</button>
      </div>
    </div>


    <script>
        // Glob√°ln√≠ promƒõnn√© (deklarace z≈Øst√°v√° naho≈ôe, aby byly dostupn√© v cel√©m skriptu)
        let weightChart, bmiChart, bodyFatOnlyChart, muscleMassOnlyChart, bodyWaterChart, manualBMRChart, manualAMRChart;
        let weightLog = [];
        let settings = {
            height: 174,
            age: 24,
            gender: 'male',
            activityLevel: 1.55,
            bmiWarningUpper: 25,
            bmiDangerUpper: 30,
            bmiWarningLower: 18.5,
            reminderEnabled: true,
            reminderInterval: 7
        };
        let goals = {
            targetWeight: 80,
            targetBMI: 24.9,
            targetDate: '2026-05-18',
            weeklyGoal: null
        };

        const ACTIVITY_LEVELS = {
            SEDENTARY: 1.2,
            LIGHT: 1.375,
            MODERATE: 1.55,
            ACTIVE: 1.725,
            VERY_ACTIVE: 1.9
        };

        // Supabase konfigurace a klient (Deklarujeme zde, inicializujeme v window.onload)
        const SUPABASE_URL = 'https://aknjpurxdbtsxillmqbd.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrbmpwdXJ4ZGJ0c3hpbGxtcWJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxOTEzMzAsImV4cCI6MjA2Mzc2NzMzMH0.otk-74BBM-SwC_zA0WqcwGVab5lBfrLiyeYOmh4Xio';
        let supabase; // Deklarujeme, ale inicializujeme a≈æ po naƒçten√≠ okna


        // Funkce pro ulo≈æen√≠ dat do Supabase (Glob√°ln√≠)
        async function saveWeightLogToSupabase(data) {
            const formattedData = data.map(entry => ({
                date: entry.date,
                weight: entry.weight,
                body_fat: entry.bodyFat,
                muscle_mass: entry.muscleMass,
                body_water: entry.bodyWater,
                manual_bmr: entry.manualBMR,
                manual_amr: entry.manualAMR,
                notes: entry.notes
            }));

            try {
                const { data: insertedData, error } = await supabase
                    .from('weight_entries')
                    .upsert(formattedData, { onConflict: 'date' }); 

                if (error) {
                    console.error('Chyba p≈ôi ukl√°d√°n√≠ dat do Supabase:', error.message);
                    throw error;
                }
                console.log('Data √∫spƒõ≈°nƒõ ulo≈æena do Supabase:', insertedData);
                return insertedData;
            } catch (err) {
                console.error('Nastala chyba p≈ôi ukl√°d√°n√≠ do Supabase:', err);
                throw err;
            }
        }

        // Funkce pro naƒçten√≠ dat ze Supabase (Glob√°ln√≠)
        async function loadWeightLogFromSupabase() {
            try {
                const { data, error } = await supabase
                    .from('weight_entries')
                    .select('*')
                    .order('date', { ascending: true });

                if (error) {
                    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ dat ze Supabase:', error.message);
                    throw error;
                }

                const loadedData = data.map(entry => ({
                    date: entry.date,
                    weight: parseFloat(entry.weight),
                    bodyFat: entry.body_fat ? parseFloat(entry.body_fat) : null,
                    muscleMass: entry.muscle_mass ? parseFloat(entry.muscle_mass) : null,
                    bodyWater: entry.body_water ? parseFloat(entry.body_water) : null,
                    manualBMR: entry.manual_bmr || null,
                    manualAMR: entry.manual_amr || null,
                    notes: entry.notes || ''
                }));
                
                console.log('Data √∫spƒõ≈°nƒõ naƒçtena ze Supabase:', loadedData);
                return loadedData;
            } catch (err) {
                console.error('Nastala chyba p≈ôi naƒç√≠t√°n√≠ ze Supabase:', err);
                return [];
            }
        }


        // Custom Confirmation Modal JS
        let resolveConfirmPromise;

        function showModalConfirm(message) {
            const modal = document.getElementById('customConfirmModal');
            const msgEl = document.getElementById('confirmMessage');
            const btnYes = document.getElementById('confirmYes');
            const btnNo = document.getElementById('confirmNo');

            msgEl.textContent = message;
            modal.style.display = 'block';

            return new Promise((resolve) => {
                resolveConfirmPromise = resolve;

                btnYes.onclick = () => {
                    modal.style.display = 'none';
                    resolveConfirmPromise(true);
                };

                btnNo.onclick = () => {
                    modal.style.display = 'none';
                    resolveConfirmPromise(false);
                };
            });
        }
        
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entryDate').value = today;
        }

        function updateForms() {
            document.getElementById('height').value = settings.height || '';
            document.getElementById('age').value = settings.age || '';
            document.getElementById('gender').value = settings.gender || 'male';
            document.getElementById('activityLevel').value = settings.activityLevel || '1.55';
            document.getElementById('bmiWarningUpper').value = settings.bmiWarningUpper || '';
            document.getElementById('bmiDangerUpper').value = settings.bmiDangerUpper || '';
            document.getElementById('bmiWarningLower').value = settings.bmiWarningLower || '';
            document.getElementById('reminderEnabled').checked = settings.reminderEnabled === true;
            document.getElementById('reminderInterval').value = settings.reminderInterval || 7;

            document.getElementById('targetWeight').value = goals.targetWeight || '';
            document.getElementById('targetBMI').value = goals.targetBMI || '';
            document.getElementById('targetDate').value = goals.targetDate || '';
            document.getElementById('weeklyGoal').value = goals.weeklyGoal || '';
        }

        function calculateBMI(weight, height) {
            if (!height || height <=0 || !weight || weight <=0) return 0;
            const heightInMeters = height / 100;
            return weight / (heightInMeters * heightInMeters);
        }

        function calculateBMR(weight, height, age, gender) {
            if (!weight || !height || !age || !gender) return 0;
            if (gender === 'male') {
                return (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else {
                return (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }
        }

        function calculateAMR(bmr, activityLevel) {
            if (!bmr || !activityLevel) return 0;
            return bmr * activityLevel;
        }

        function classifyBMI(bmi) {
            if (bmi === 0) return { class: '', text: '-' };
            if (bmi < 18.5) return { class: 'bmi-underweight', text: 'Podv√°ha' };
            if (bmi < 25) return { class: 'bmi-normal', text: 'Norm√°ln√≠' };
            if (bmi < 30) return { class: 'bmi-overweight', text: 'Nadv√°ha' };
            return { class: 'bmi-obese', text: 'Obezita' };
        }

        function checkBMIAlert(bmi) {
            const alertEl = document.getElementById('bmiAlert');
            if (bmi === 0) {
                alertEl.className = 'alert';
                return;
            }
            if (bmi > settings.bmiDangerUpper) {
                alertEl.innerHTML = `‚ö†Ô∏è Varov√°n√≠: Va≈°e BMI (${bmi.toFixed(1)}) je v√Ωraznƒõ nad doporuƒçenou hranic√≠!`;
                alertEl.className = 'alert show';
                alertEl.style.background = '#ff5555';
            } else if (bmi > settings.bmiWarningUpper) {
                alertEl.innerHTML = `‚ö° Upozornƒõn√≠: Va≈°e BMI (${bmi.toFixed(1)}) p≈ôekraƒçuje doporuƒçenou hranici.`;
                alertEl.className = 'alert show';
                alertEl.style.background = '#ffaa00';
            } else if (bmi < settings.bmiWarningLower && bmi > 0) {
                alertEl.innerHTML = `‚ö° Upozornƒõn√≠: Va≈°e BMI (${bmi.toFixed(1)}) je pod doporuƒçenou hranic√≠.`;
                alertEl.className = 'alert show';
                alertEl.style.background = '#00aaff';
            } else {
                alertEl.className = 'alert';
            }
        }

        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }
        
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return 'Neplatn√© datum';
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            return `${day}. ${month}. ${year}`;
        }

        function initializeCharts() {
            const commonOptions = (yLabel, xLabelColor = '#00d9ff', yLabelColor = '#00d9ff', gridColor = '#444', yPrecision = 1) => ({
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        grid: { color: gridColor },
                        ticks: { color: yLabelColor, precision: yPrecision },
                        title: { display: !!yLabel, text: yLabel, color: yLabelColor }
                    },
                    x: {
                        grid: { color: gridColor },
                        ticks: { color: xLabelColor, autoSkip: true, maxTicksLimit: 10 }
                    }
                },
                plugins: {
                    legend: { labels: { color: xLabelColor } }
                }
            });
            
            const lineChartDataset = (label, data, borderColor, bgColor) => ({
                label: label,
                data: data,
                borderColor: borderColor,
                backgroundColor: bgColor,
                tension: 0.1,
                pointBackgroundColor: borderColor,
                pointBorderColor: '#fff',
                pointRadius: 4,
                pointHoverRadius: 6
            });

            // Destroy existing chart instances before re-initializing
            if (weightChart) weightChart.destroy();
            if (bmiChart) bmiChart.destroy();
            if (bodyFatOnlyChart) bodyFatOnlyChart.destroy();
            if (muscleMassOnlyChart) muscleMassOnlyChart.destroy();
            if (bodyWaterChart) bodyWaterChart.destroy();
            if (manualBMRChart) manualBMRChart.destroy();
            if (manualAMRChart) manualAMRChart.destroy();

            weightChart = new Chart(document.getElementById('weightChart').getContext('2d'), {
                type: 'line',
                data: { labels: [], datasets: [lineChartDataset('V√°ha (kg)', [], '#00d9ff', 'rgba(0,217,255,0.2)')] },
                options: commonOptions('V√°ha (kg)')
            });

            bmiChart = new Chart(document.getElementById('bmiChart').getContext('2d'), {
                type: 'line',
                data: { labels: [], datasets: [lineChartDataset('BMI', [], '#55ff99', 'rgba(85,255,153,0.2)')] },
                options: commonOptions('BMI')
            });

            bodyWaterChart = new Chart(document.getElementById('bodyWaterChart').getContext('2d'), {
                type: 'line',
                data: { labels: [], datasets: [lineChartDataset('Voda v tƒõle (%)', [], '#00aaff', 'rgba(0,170,255,0.2)')] },
                options: commonOptions('Voda v tƒõle (%)')
            });
            
            manualBMRChart = new Chart(document.getElementById('manualBMRChart').getContext('2d'), {
                type: 'line',
                data: { labels: [], datasets: [lineChartDataset('Zadan√© BMR (kcal)', [], '#ff9933', 'rgba(255,153,51,0.2)')] },
                options: commonOptions('BMR (kcal)', undefined, undefined, undefined, 0)
            });

            manualAMRChart = new Chart(document.getElementById('manualAMRChart').getContext('2d'), {
                type: 'line',
                data: { labels: [], datasets: [lineChartDataset('Zadan√© AMR (kcal)', [], '#cc66ff', 'rgba(204,102,255,0.2)')] },
                options: commonOptions('AMR (kcal)', undefined, undefined, undefined, 0)
            });
            
            bodyFatOnlyChart = new Chart(document.getElementById('bodyFatOnlyChart').getContext('2d'), {
                type: 'line',
                data: { labels: [], datasets: [lineChartDataset('Tƒõlesn√Ω tuk (%)', [], '#ff5555', 'rgba(255,85,85,0.2)')]},
                options: commonOptions('Tuk (%)')
            });

            muscleMassOnlyChart = new Chart(document.getElementById('muscleMassOnlyChart').getContext('2d'), {
                type: 'line',
                data: { labels: [], datasets: [lineChartDataset('Svalov√° hmota (%)', [], '#ffff55', 'rgba(255,255,85,0.2)')]},
                options: commonOptions('Svaly (%)')
            });
        }

        function updateCharts() {
            if (!weightLog || weightLog.length === 0) return;
            const sortedData = [...weightLog].sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = sortedData.map(entry => formatDateForDisplay(entry.date));
            
            const weights = sortedData.map(entry => entry.weight);
            const bmis = sortedData.map(entry => calculateBMI(entry.weight, settings.height).toFixed(1));
            const bodyFats = sortedData.map(entry => entry.bodyFat);
            
            const muscleMassPercentages = sortedData.map(entry => {
                if (entry.muscleMass && entry.weight && entry.weight > 0) {
                    return parseFloat(((entry.muscleMass / entry.weight) * 100).toFixed(1));
                }
                return NaN;
            });

            const bodyWaters = sortedData.map(entry => entry.bodyWater);
            const manualBMRs = sortedData.map(entry => entry.manualBMR);
            const manualAMRs = sortedData.map(entry => entry.manualAMR);


            weightChart.data.labels = labels;
            weightChart.data.datasets[0].data = weights;
            weightChart.update();

            bmiChart.data.labels = labels;
            bmiChart.data.datasets[0].data = bmis;
            bmiChart.update();

            bodyWaterChart.data.labels = labels;
            bodyWaterChart.data.datasets[0].data = bodyWaters.map(bw => bw === null || bw === undefined ? NaN : bw);
            bodyWaterChart.update();
            
            manualBMRChart.data.labels = labels;
            manualBMRChart.data.datasets[0].data = manualBMRs.map(val => val === null || val === undefined ? NaN : val);
            manualBMRChart.update();

            manualAMRChart.data.labels = labels;
            manualAMRChart.data.datasets[0].data = manualAMRs.map(val => val === null || val === undefined ? NaN : val);
            manualAMRChart.update();
            
            bodyFatOnlyChart.data.labels = labels;
            bodyFatOnlyChart.data.datasets[0].data = bodyFats.map(bf => bf === null || bf === undefined ? NaN : bf);
            bodyFatOnlyChart.update();

            muscleMassOnlyChart.data.labels = labels;
            muscleMassOnlyChart.data.datasets[0].data = muscleMassPercentages;
            muscleMassOnlyChart.update();
        }

        function updateTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            if (!weightLog || settings.height <=0) return;

            const sortedData = [...weightLog].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedData.forEach((entry, index) => {
                const bmi = calculateBMI(entry.weight, settings.height);
                const classification = classifyBMI(bmi);
                
                let weightDiffText = '-';
                let diffClass = '';
                const chronologicalIndex = weightLog.slice().sort((a, b) => new Date(a.date) - new Date(b.date)).findIndex(e => e.date === entry.date);
                const previousChronologicalEntry = chronologicalIndex > 0 ? weightLog.slice().sort((a,b) => new Date(a.date) - new Date(b.date))[chronologicalIndex -1] : null;

                if (previousChronologicalEntry) {
                    const weightDiff = (entry.weight - previousChronologicalEntry.weight);
                    weightDiffText = (weightDiff > 0 ? '+' : '') + weightDiff.toFixed(1);
                    diffClass = weightDiff > 0 ? 'gain' : (weightDiff < 0 ? 'loss' : '');
                }

                let muscleMassDisplay = '-';
                if (entry.muscleMass && entry.weight && entry.weight > 0) {
                    muscleMassDisplay = ((entry.muscleMass / entry.weight) * 100).toFixed(1) + '%';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sortedData.length - index}</td>
                    <td>${formatDateForDisplay(entry.date)}</td>
                    <td>${entry.weight !== null && entry.weight !== undefined ? entry.weight.toFixed(1) : '-'}</td>
                    <td class="${diffClass}">${weightDiffText}</td>
                    <td class="${classification.class}">${bmi > 0 ? bmi.toFixed(1) : '-'}</td>
                    <td class="${classification.class}">${classification.text}</td>
                    <td>${entry.bodyFat !== null && entry.bodyFat !== undefined ? entry.bodyFat.toFixed(1) : '-'}%</td>
                    <td>${muscleMassDisplay}</td>
                    <td>${entry.bodyWater !== null && entry.bodyWater !== undefined ? entry.bodyWater.toFixed(1) : '-'}%</td>
                    <td>${entry.manualBMR !== null && entry.manualBMR !== undefined ? entry.manualBMR : '-'}</td>
                    <td>${entry.manualAMR !== null && entry.manualAMR !== undefined ? entry.manualAMR : '-'}</td>
                    <td title="${entry.notes || ''}">${(entry.notes || '').substring(0,10)}${(entry.notes || '').length > 10 ? '...' : ''}</td>
                    <td>
                        <button class="danger" onclick="deleteEntry('${entry.date}')" title="Smazat">üóëÔ∏è</button>
                        <button onclick="editEntry('${entry.date}')" title="Upravit">‚úèÔ∏è</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function updateStats() {
            if (weightLog.length === 0) {
                document.getElementById('currentWeight').textContent = '-';
                document.getElementById('currentBMI').textContent = '-';
                document.getElementById('currentBMI').className = 'stat-value';
                document.getElementById('weightChange').textContent = '-';
                document.getElementById('weightChange').className = 'stat-value';
                document.getElementById('currentBodyWater').textContent = '-';
                document.getElementById('lastManualBMR').textContent = '-';
                document.getElementById('lastManualAMR').textContent = '-';
                document.getElementById('theoreticalBMR').textContent = '-';
                document.getElementById('theoreticalAMR').textContent = '-';
                document.getElementById('goalProgress').textContent = '-';
                document.getElementById('goalProgressBarCard').style.display = 'none';
                document.getElementById('latestEntryDate').textContent = '≈Ω√°dn√° data k zobrazen√≠.';
                return;
            }

            const sortedLog = [...weightLog].sort((a, b) => new Date(a.date) - new Date(b.date));
            const latestEntry = sortedLog[sortedLog.length - 1];
            
            const currentWeight = latestEntry.weight;
            const currentBMI = calculateBMI(currentWeight, settings.height);
            const currentBodyWater = latestEntry.bodyWater;

            document.getElementById('currentWeight').textContent = currentWeight.toFixed(1);
            document.getElementById('currentBMI').textContent = currentBMI > 0 ? currentBMI.toFixed(1) : '-';
            document.getElementById('currentBMI').className = 'stat-value ' + classifyBMI(currentBMI).class;
            document.getElementById('currentBodyWater').textContent = currentBodyWater !== null && currentBodyWater !== undefined ? currentBodyWater.toFixed(1) : '-';
            document.getElementById('lastManualBMR').textContent = latestEntry.manualBMR !== null && latestEntry.manualBMR !== undefined ? latestEntry.manualBMR : '-';
            document.getElementById('lastManualAMR').textContent = latestEntry.manualAMR !== null && latestEntry.manualAMR !== undefined ? latestEntry.manualAMR : '-';

            let weightChangeVal = 0;
            let weightChangeText = '-';
            let changeClass = '';
            if (sortedLog.length >= 2) {
                const previousEntry = sortedLog[sortedLog.length - 2];
                weightChangeVal = currentWeight - previousEntry.weight;
                weightChangeText = (weightChangeVal >= 0 ? '+' : '') + weightChangeVal.toFixed(1);
                changeClass = weightChangeVal > 0 ? 'gain' : (weightChangeVal < 0 ? 'loss' : '');
            }
            document.getElementById('weightChange').textContent = weightChangeText;
            document.getElementById('weightChange').className = 'stat-value ' + changeClass;

            const theoBMR = calculateBMR(currentWeight, settings.height, settings.age, settings.gender);
            const theoAMR = calculateAMR(theoBMR, settings.activityLevel);
            document.getElementById('theoreticalBMR').textContent = theoBMR > 0 ? Math.round(theoBMR) : '-';
            document.getElementById('theoreticalAMR').textContent = theoAMR > 0 ? Math.round(theoAMR) : '-';
            
            document.getElementById('latestEntryDate').textContent = `Posledn√≠ z√°znam: ${formatDateForDisplay(latestEntry.date)}`;

            if (goals.targetWeight && sortedLog.length > 0) {
                const initialWeight = sortedLog[0].weight;
                const totalChangeNeeded = goals.targetWeight - initialWeight;
                const currentChangeAchieved = currentWeight - initialWeight;
                let progressPercent = 0;

                if (totalChangeNeeded !== 0) {
                    if ((totalChangeNeeded < 0 && currentWeight <= initialWeight && currentWeight >= goals.targetWeight) ||
                        (totalChangeNeeded > 0 && currentWeight >= initialWeight && currentWeight <= goals.targetWeight)) {
                        progressPercent = (Math.abs(currentChangeAchieved) / Math.abs(totalChangeNeeded)) * 100;
                    } else if ((totalChangeNeeded < 0 && currentWeight < goals.targetWeight) || (totalChangeNeeded > 0 && currentWeight > goals.targetWeight)) {
                        progressPercent = 100;
                    } else {
                        progressPercent = 0;
                    }
                } else {
                    progressPercent = (initialWeight === currentWeight) ? 100 : 0;
                }
                progressPercent = Math.min(100, Math.max(0, progressPercent));

                document.getElementById('goalProgress').textContent = `${progressPercent.toFixed(1)}%`;
                document.getElementById('goalProgressBarCard').style.display = 'block';
                document.getElementById('progressFill').style.width = `${progressPercent}%`;
                
                const remainingKg = goals.targetWeight - currentWeight;
                if (progressPercent >= 100) {
                    document.getElementById('goalStatus').textContent = `üéâ C√≠l ${goals.targetWeight} kg dosa≈æen/p≈ôekon√°n!`;
                } else {
                    document.getElementById('goalStatus').textContent = `Zb√Ωv√°: ${remainingKg.toFixed(1)} kg do c√≠le (${goals.targetWeight} kg)`;
                }

                const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;
                const now = new Date();
                const recentLog = sortedLog.filter(entry => (now - new Date(entry.date)) <= THIRTY_DAYS_MS);

                if (recentLog.length >= 2 && remainingKg !== 0) {
                    const oldestRecent = recentLog[0];
                    const latestRecent = recentLog[recentLog.length - 1];
                    const daysElapsed = Math.max(1, Math.floor((new Date(latestRecent.date) - new Date(oldestRecent.date)) / (1000 * 60 * 60 * 24)));
                    const weightChangeInPeriod = latestRecent.weight - oldestRecent.weight;
                    const dailyChange = weightChangeInPeriod / daysElapsed;
                    let estimateText = 'Nedostatek dat pro odhad.';

                    if (dailyChange !== 0 && ((remainingKg < 0 && dailyChange < 0) || (remainingKg > 0 && dailyChange > 0))) {
                        const estimatedDays = Math.abs(remainingKg / dailyChange);
                        if (estimatedDays > 365 * 3) {
                            estimateText = 'Odhad: v√≠ce ne≈æ 3 roky';
                        } else if (estimatedDays > 365) {
                            estimateText = `Odhad: cca ${Math.round(estimatedDays/30.44)} mƒõs√≠c≈Ø`;
                        } else {
                            estimateText = `Odhad: cca ${Math.round(estimatedDays)} dn√≠ (~${Math.round(estimatedDays / 7)} t√Ωdn≈Ø)`;
                        }
                    } else if (dailyChange === 0 && remainingKg !== 0) {
                        estimateText = 'Odhad: stagnace, c√≠l se nep≈ôibli≈æuje.';
                    } else if (remainingKg !== 0) {
                        estimateText = 'Odhad: aktu√°lnƒõ se vzdalujete od c√≠le.';
                    }
                    document.getElementById('goalEstimate').textContent = estimateText;
                } else if (remainingKg === 0) {
                    document.getElementById('goalEstimate').textContent = 'C√≠l dosa≈æen!';
                } else {
                    document.getElementById('goalEstimate').textContent = 'Nedostatek dat za posl. 30 dn√≠ pro odhad.';
                }
            } else {
                document.getElementById('goalProgress').textContent = '-';
                document.getElementById('goalProgressBarCard').style.display = 'none';
                document.getElementById('goalEstimate').textContent = 'C√≠l nen√≠ nastaven.';
            }
            checkBMIAlert(currentBMI);
        }

        function updateRecommendations() {
            if (weightLog.length === 0 ) {
                document.getElementById('recommendationText').innerHTML = '<p>Pro doporuƒçen√≠ zadejte v√≠ce dat.</p>';
                return;
            }
            const sortedDataDesc = [...weightLog].sort((a, b) => new Date(b.date) - new Date(a.date));
            const latestEntry = sortedDataDesc[0];
            const currentWeight = latestEntry.weight;
            const currentBMI = calculateBMI(currentWeight, settings.height);
            
            let recommendations = [];

            if (currentBMI > 0) {
                if (currentBMI < 18.5) recommendations.push("üíö Va≈°e BMI naznaƒçuje podv√°hu. Zva≈æte konzultaci s l√©ka≈ôem o zdrav√©m p≈ô√≠r≈Østku v√°hy.");
                else if (currentBMI > settings.bmiDangerUpper) recommendations.push("‚ù§Ô∏è Va≈°e BMI je v p√°smu obezity. D≈Øraznƒõ doporuƒçujeme konzultaci s l√©ka≈ôem a √∫pravu ≈æivotn√≠ho stylu.");
                else if (currentBMI > settings.bmiWarningUpper) recommendations.push("üíõ Va≈°e BMI signalizuje nadv√°hu. Doporuƒçujeme zamƒõ≈ôit se na vyv√°≈æenou stravu a pravideln√Ω pohyb.");
                else recommendations.push("‚úÖ Va≈°e BMI je v norm√°ln√≠m rozmez√≠. Udr≈æujte si zdrav√Ω ≈æivotn√≠ styl!");
            } else if(settings.height) {
                recommendations.push("‚ö†Ô∏è Zadejte v√Ω≈°ku pro v√Ωpoƒçet BMI a relevantn√≠ doporuƒçen√≠.");
            }

            const sevenDaysAgo = new Date(new Date().setDate(new Date().getDate() - 7));
            const fourteenDaysAgo = new Date(new Date().setDate(new Date().getDate() - 14));
            
            const last7DaysEntries = weightLog.filter(e => new Date(e.date) >= sevenDaysAgo);
            const prev7DaysEntries = weightLog.filter(e => new Date(e.date) >= fourteenDaysAgo && new Date(e.date) < sevenDaysAgo);

            if (last7DaysEntries.length > 1 && prev7DaysEntries.length > 1) {
                const avgLast7 = last7DaysEntries.reduce((sum, e) => sum + e.weight, 0) / last7DaysEntries.length;
                const avgPrev7 = prev7DaysEntries.reduce((sum, e) => sum + e.weight, 0) / prev7DaysEntries.length;
                const weeklyTrend = avgLast7 - avgPrev7;

                if (Math.abs(weeklyTrend) > 1.5) {
                    recommendations.push(`‚ö†Ô∏è Rychl√° zmƒõna v√°hy (${weeklyTrend.toFixed(1)} kg/t√Ωden pr≈Ømƒõrnƒõ). Zva≈æte pozvolnƒõj≈°√≠ tempo (ide√°lnƒõ 0.5-1 kg/t√Ωden).`);
                } else if (weeklyTrend !== 0) {
                    recommendations.push(`üìà T√Ωdenn√≠ trend v√°hy: ${weeklyTrend.toFixed(1)} kg. Pokraƒçujte ve sv√©m √∫sil√≠!`);
                }
            } else if (last7DaysEntries.length >=2) {
                const sortedWeek = last7DaysEntries.sort((a,b) => new Date(a.date) - new Date(b.date));
                const weekChange = sortedWeek[sortedWeek.length-1].weight - sortedWeek[0].weight;
                if (Math.abs(weekChange) > 1.5) {
                    recommendations.push(`‚ö†Ô∏è Rychl√° zmƒõna v√°hy za posledn√≠ dny: ${weekChange.toFixed(1)} kg. Doporuƒçujeme pozvolnƒõj≈°√≠ zmƒõny.`);
                }
            }

            if (goals.targetWeight && goals.targetDate) {
                const daysToGoal = Math.ceil((new Date(goals.targetDate) - new Date()) / (1000 * 60 * 60 * 24));
                const weightToChange = goals.targetWeight - currentWeight;
                
                if (daysToGoal > 0 && weightToChange !== 0) {
                    const requiredWeeklyChange = (weightToChange / (daysToGoal / 7)).toFixed(1);
                    recommendations.push(`üéØ Pro dosa≈æen√≠ c√≠le (${goals.targetWeight} kg) do ${formatDateForDisplay(goals.targetDate)}, je pot≈ôeba pr≈Ømƒõrn√° t√Ωdenn√≠ zmƒõna ${requiredWeeklyChange} kg.`);
                    if (Math.abs(requiredWeeklyChange) > 1.5) {
                        recommendations.push("üí° Tento t√Ωdenn√≠ c√≠l je pomƒõrnƒõ ambici√≥zn√≠. Ujistƒõte se, ≈æe je udr≈æiteln√Ω a zdrav√Ω.");
                    }
                } else if (weightToChange === 0) {
                    recommendations.push(`üéØ C√≠lov√° v√°ha ${goals.targetWeight} kg dosa≈æena! Gratulujeme!`);
                } else if (daysToGoal <=0 && weightToChange !==0) {
                    recommendations.push(`üóìÔ∏è Term√≠n pro c√≠l ${goals.targetWeight} kg ji≈æ vypr≈°el. Zva≈æte nastaven√≠ nov√©ho c√≠le.`);
                }
            } else if (goals.targetWeight) {
                const weightToChange = goals.targetWeight - currentWeight;
                if (weightToChange === 0) recommendations.push(`üéØ C√≠lov√° v√°ha ${goals.targetWeight} kg dosa≈æena!`);
                else recommendations.push(`üéØ C√≠l: ${goals.targetWeight} kg. Aktu√°lnƒõ zb√Ωv√° ${weightToChange.toFixed(1)} kg.`);
            }

            const theoBMR = calculateBMR(currentWeight, settings.height, settings.age, settings.gender);
            const theoAMR = calculateAMR(theoBMR, settings.activityLevel);
            
            if (theoAMR > 0 && goals.weeklyGoal) {
                const weeklyCalDeficitOrSurplus = goals.weeklyGoal * 7700;
                const dailyCalAdjustment = weeklyCalDeficitOrSurplus / 7;
                const targetCalories = Math.round(theoAMR + dailyCalAdjustment);
                let goalType = goals.weeklyGoal < 0 ? "hubnut√≠" : (goals.weeklyGoal > 0 ? "nab√≠r√°n√≠" : "udr≈æov√°n√≠");

                recommendations.push(`üî• Pro t√Ωdenn√≠ c√≠l ${goals.weeklyGoal} kg (${goalType}), v√°≈° odhadovan√Ω denn√≠ p≈ô√≠jem by mohl b√Ωt okolo ${targetCalories} kcal (Teoretick√Ω AMR: ${Math.round(theoAMR)} kcal).`);
                if (targetCalories < theoBMR && goals.weeklyGoal < 0) {
                    recommendations.push("‚ùó V√°≈° c√≠lov√Ω denn√≠ p≈ô√≠jem je pod va≈°√≠m teoretick√Ωm BMR. Dlouhodobƒõ to nemus√≠ b√Ωt udr≈æiteln√©. Zva≈æte m√≠rnƒõj≈°√≠ c√≠l nebo konzultaci s odborn√≠kem.");
                }
            } else if (theoAMR > 0 && latestEntry.manualAMR) {
                recommendations.push(`üí° V√°≈° posledn√≠ zadan√Ω AMR je ${latestEntry.manualAMR} kcal. Teoreticky vypoƒçten√Ω AMR je ${Math.round(theoAMR)} kcal. Rozd√≠l m≈Ø≈æe b√Ωt d√°n specifickou aktivitou nebo metodikou mƒõ≈ôen√≠.`);
            }
            document.getElementById('recommendationText').innerHTML = recommendations.length > 0 ? recommendations.map(rec => `<p>${rec}</p>`).join('') : '<p>≈Ω√°dn√° specifick√° doporuƒçen√≠. Udr≈æujte zdrav√© n√°vyky!</p>';
        }

        function updateDisplay() {
            updateTable();
            updateCharts();
            updateStats();
            updateRecommendations();
        }

        document.getElementById('entryForm').addEventListener('submit', async function(e) { // Zmƒõnƒõno na async
            e.preventDefault();
            const date = document.getElementById('entryDate').value;
            const weight = parseFloat(document.getElementById('entryWeight').value);
            const bodyFat = document.getElementById('entryBodyFat').value ? parseFloat(document.getElementById('entryBodyFat').value) : null;
            const muscleMass = document.getElementById('entryMuscleMass').value ? parseFloat(document.getElementById('entryMuscleMass').value) : null;
            const bodyWater = document.getElementById('entryBodyWater').value ? parseFloat(document.getElementById('entryBodyWater').value) : null;
            const manualBMR = document.getElementById('entryManualBMR').value ? parseInt(document.getElementById('entryManualBMR').value) : null;
            const manualAMR = document.getElementById('entryManualAMR').value ? parseInt(document.getElementById('entryManualAMR').value) : null;
            const notes = document.getElementById('entryNotes').value;

            if (isNaN(weight) || weight <= 0) {
                showNotification('Chyba: Zadejte platnou v√°hu.', 3000);
                return;
            }

            const newEntryData = { date, weight, bodyFat, muscleMass, bodyWater, manualBMR, manualAMR, notes };

            const existingIndex = weightLog.findIndex(entry => entry.date === date);
            if (existingIndex !== -1) {
                // Nahrazeno confirm() vlastn√≠m mod√°ln√≠m oknem
                if (await showModalConfirm('Z√°znam pro tento datum ji≈æ existuje. Chcete ho p≈ôepsat?')) {
                    weightLog[existingIndex] = newEntryData;
                } else return;
            } else {
                weightLog.push(newEntryData);
            }
            await saveData(); // Nyn√≠ je saveData() asynchronn√≠
            updateDisplay();
            showNotification('Z√°znam byl √∫spƒõ≈°nƒõ p≈ôid√°n/aktualizov√°n!');
            this.reset();
            setTodayDate();
            showTab('dashboard');
        });

        document.getElementById('settingsForm').addEventListener('submit', async function(e) { // Zmƒõnƒõno na async
            e.preventDefault();
            settings.height = parseInt(document.getElementById('height').value);
            settings.age = document.getElementById('age').value ? parseInt(document.getElementById('age').value) : null;
            settings.gender = document.getElementById('gender').value;
            settings.activityLevel = parseFloat(document.getElementById('activityLevel').value);
            await saveData(); // Nyn√≠ je saveData() asynchronn√≠
            updateDisplay();
            showNotification('Nastaven√≠ byla ulo≈æena!');
        });

        document.getElementById('bmiAlertsForm').addEventListener('submit', async function(e) { // Zmƒõnƒõno na async
            e.preventDefault();
            settings.bmiWarningUpper = parseFloat(document.getElementById('bmiWarningUpper').value);
            settings.bmiDangerUpper = parseFloat(document.getElementById('bmiDangerUpper').value);
            settings.bmiWarningLower = parseFloat(document.getElementById('bmiWarningLower').value);
            await saveData(); // Nyn√≠ je saveData() asynchronn√≠
            updateDisplay();
            showNotification('BMI hranice byly ulo≈æeny!');
        });

        document.getElementById('remindersForm').addEventListener('submit', async function(e) { // Zmƒõnƒõno na async
            e.preventDefault();
            settings.reminderEnabled = document.getElementById('reminderEnabled').checked;
            settings.reminderInterval = parseInt(document.getElementById('reminderInterval').value);
            await saveData(); // Nyn√≠ je saveData() asynchronn√≠
            showNotification('Nastaven√≠ p≈ôipom√≠nek bylo ulo≈æeno!');
        });

        document.getElementById('goalsForm').addEventListener('submit', async function(e) { // Zmƒõnƒõno na async
            e.preventDefault();
            goals.targetWeight = document.getElementById('targetWeight').value ? parseFloat(document.getElementById('targetWeight').value) : null;
            goals.targetBMI = document.getElementById('targetBMI').value ? parseFloat(document.getElementById('targetBMI').value) : null;
            goals.targetDate = document.getElementById('targetDate').value || null;
            goals.weeklyGoal = document.getElementById('weeklyGoal').value ? parseFloat(document.getElementById('weeklyGoal').value) : null;
            await saveData(); // Nyn√≠ je saveData() asynchronn√≠
            updateDisplay();
            showNotification('C√≠le byly ulo≈æeny!');
        });

        async function deleteEntry(date) { // Zmƒõnƒõno na async
            // Nahrazeno confirm() vlastn√≠m mod√°ln√≠m oknem
            if (await showModalConfirm(`Opravdu chcete smazat z√°znam ze dne ${formatDateForDisplay(date)}?`)) {
                weightLog = weightLog.filter(entry => entry.date !== date);
                await saveData(); // Nyn√≠ je saveData() asynchronn√≠
                updateDisplay();
                showNotification('Z√°znam byl smaz√°n!');
            }
        }

        function editEntry(date) {
            const entry = weightLog.find(e => e.date === date);
            if (entry) {
                document.getElementById('entryDate').value = entry.date;
                document.getElementById('entryWeight').value = entry.weight;
                document.getElementById('entryBodyFat').value = entry.bodyFat || '';
                document.getElementById('entryMuscleMass').value = entry.muscleMass || '';
                document.getElementById('entryBodyWater').value = entry.bodyWater || '';
                document.getElementById('entryManualBMR').value = entry.manualBMR || '';
                document.getElementById('entryManualAMR').value = entry.manualAMR || '';
                document.getElementById('entryNotes').value = entry.notes || '';
                showTab('add-entry');
                showNotification(`Z√°znam ze dne ${formatDateForDisplay(date)} naƒçten pro editaci.`);
            }
        }

        function exportToCSV() {
            if (weightLog.length === 0) {
                showNotification("Nen√≠ co exportovat.", 2000);
                return;
            }
            const headers = ['Datum', 'Vaha (kg)', 'BMI', 'Telesny tuk (%)', 'Svalova hmota (%)', 'Svalova hmota (%)', 'Voda v tele (%)', 'Manual BMR', 'Manual AMR', 'Poznamky'];
            const rows = weightLog.map(entry => {
                let musclePercent = '';
                if (entry.muscleMass && entry.weight && entry.weight > 0) {
                    musclePercent = ((entry.muscleMass / entry.weight) * 100).toFixed(1);
                }
                return [
                    entry.date,
                    entry.weight,
                    calculateBMI(entry.weight, settings.height).toFixed(1),
                    entry.bodyFat || '',
                    musclePercent,
                    entry.muscleMass || '',
                    entry.bodyWater || '',
                    entry.manualBMR || '',
                    entry.manualAMR || '',
                    `"${(entry.notes || '').replace(/"/g, '""')}"`
                ];
            });

            const csvContent = "data:text/csv;charset=utf-8," +
                headers.join(',') + '\n' +
                rows.map(row => row.join(',')).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `vaha_export_Jirik_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('CSV export dokonƒçen!');
        }

        function exportToPDF() {
            if (weightLog.length === 0) {
                showNotification("Nen√≠ co exportovat.", 2000);
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(18);
            doc.text('V√°hov√Ω report - Admir√°l Ji≈ô√≠k', 14, 22);
            doc.setFontSize(11);
            doc.text(`Generov√°no: ${formatDateForDisplay(new Date().toISOString().split('T')[0])}`, 14, 30);
            doc.text(`V√Ω≈°ka: ${settings.height} cm, Vƒõk: ${settings.age || '-'} let, Pohlav√≠: ${settings.gender === 'male' ? 'Mu≈æ' : '≈Ωena'}`, 14, 36);
            
            const latestEntry = [...weightLog].sort((a, b) => new Date(b.date) - new Date(a.date))[0];
            if (latestEntry) {
                const currentBMI = calculateBMI(latestEntry.weight, settings.height);
                const theoBMR = calculateBMR(latestEntry.weight, settings.height, latestEntry.age, settings.gender); // Pou≈æ√≠t latestEntry.age
                const theoAMR = calculateAMR(theoBMR, settings.activityLevel);
                doc.text(`Aktu√°ln√≠ v√°ha: ${latestEntry.weight.toFixed(1)} kg, BMI: ${currentBMI > 0 ? currentBMI.toFixed(1) : '-'}`, 14, 42);
                if (latestEntry.manualBMR || latestEntry.manualAMR) {
                    doc.text(`Posl. zadan√Ω BMR: ${latestEntry.manualBMR || '-'} kcal, AMR: ${latestEntry.manualAMR || '-'} kcal`, 14, 48);
                } else {
                    doc.text(`Teoretick√Ω BMR: ${theoBMR > 0 ? Math.round(theoBMR) : '-'} kcal, AMR: ${theoAMR > 0 ? Math.round(theoAMR) : '-'} kcal`, 14, 48);
                }
            }

            const tableColumn = ["#", "Datum", "V√°ha", "BMI", "Tuk%", "Svaly%", "Voda%", "Zad.BMR", "Zad.AMR"];
            const tableRows = [];
            const sortedLog = [...weightLog].sort((a, b) => new Date(a.date) - new Date(b.date));

            sortedLog.forEach((entry, index) => {
                const bmi = calculateBMI(entry.weight, settings.height);
                let musclePercentText = '-';
                if (entry.muscleMass && entry.weight && entry.weight > 0) {
                    musclePercentText = ((entry.muscleMass / entry.weight) * 100).toFixed(1);
                }
                const rowData = [
                    index + 1,
                    formatDateForDisplay(entry.date),
                    entry.weight.toFixed(1),
                    bmi > 0 ? bmi.toFixed(1) : '-',
                    entry.bodyFat !== null && entry.bodyFat !== undefined ? entry.bodyFat.toFixed(1) : '-',
                    musclePercentText,
                    entry.bodyWater !== null && entry.bodyWater !== undefined ? entry.bodyWater.toFixed(1) : '-',
                    entry.manualBMR !== null && entry.manualBMR !== undefined ? entry.manualBMR : '-',
                    entry.manualAMR !== null && entry.manualAMR !== undefined ? entry.manualAMR : '-',
                ];
                tableRows.push(rowData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 55,
                theme: 'grid',
                headStyles: { fillColor: [13, 17, 23], textColor: [0, 217, 255] },
                styles: { font: "Consolas", cellPadding: 1.5, fontSize: 7 },
                columnStyles: {
                    0: { cellWidth: 8 },
                    1: { cellWidth: 20 },
                }
            });
            
            doc.save(`vaha_report_Jirik_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('PDF report dokonƒçen!');
        }

        function exportChartsAsPDF() {
            if (weightLog.length === 0) {
                showNotification("Nen√≠ ƒço exportovat.", 2000);
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            let yPos = 20;
            const chartWidth = 180;
            const chartHeight = 70;
            const spacing = 10;

            doc.setFontSize(18);
            doc.text('Grafy v√Ωvoje - Admir√°l Ji≈ô√≠k', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });

            const chartsToExport = [
                { canvasId: 'weightChart', title: 'V√Ωvoj v√°hy' },
                { canvasId: 'bmiChart', title: 'V√Ωvoj BMI' },
                { canvasId: 'bodyFatOnlyChart', title: 'V√Ωvoj tƒõlesn√©ho tuku (%)' },
                { canvasId: 'muscleMassOnlyChart', title: 'V√Ωvoj svalov√© hmoty (%)' },
                { canvasId: 'bodyWaterChart', title: 'V√Ωvoj vody v tƒõle (%)' },
                { canvasId: 'manualBMRChart', title: 'V√Ωvoj zadan√©ho BMR (kcal)' },
                { canvasId: 'manualAMRChart', title: 'V√Ωvoj zadan√©ho AMR (kcal)' }
            ];

            chartsToExport.forEach((chartInfo, index) => {
                const canvas = document.getElementById(chartInfo.canvasId);
                const chartInstance = Chart.getChart(canvas);
                let hasData = false;
                if (chartInstance && chartInstance.data.labels.length > 0) {
                    hasData = chartInstance.data.datasets.some(dataset => dataset.data.some(d => d !== null && !isNaN(d) && d !== undefined));
                }

                if (!hasData) return;

                if (yPos + chartHeight + spacing > doc.internal.pageSize.getHeight() - 15 && index > 0) {
                    doc.addPage();
                    yPos = 20;
                }
                doc.setFontSize(12);
                doc.text(chartInfo.title, 15, yPos);
                yPos += 5;
                const imgData = canvas.toDataURL('image/png', 0.95);
                doc.addImage(imgData, 'PNG', 15, yPos, chartWidth, chartHeight);
                yPos += chartHeight + spacing;
            });
            
            doc.save(`vaha_grafy_Jirik_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('Grafy exportov√°ny do PDF!');
        }

        function exportBackup() {
            const backupData = {
                weightLog: weightLog,
                settings: settings,
                goals: goals,
                exportDate: new Date().toISOString(),
                appName: "Pokroƒçil√Ω v√°hov√Ω tracker v√≠ce admir√°la Ji≈ô√≠ka",
                version: "1.5.0"
            };
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `vaha_zaloha_Jirik_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('√öpln√° z√°loha vytvo≈ôena!');
        }

        async function importFromCSV(inputElement) { // Zmƒõnƒõno na async
            const file = inputElement.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) { // Zmƒõnƒõno na async
                const csv = e.target.result;
                const lines = csv.split(/\r\n|\n/);
                if (lines.length <= 1) {
                    showNotification('CSV soubor je pr√°zdn√Ω nebo neobsahuje data.', 3000);
                    inputElement.value = '';
                    return;
                }
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                // Opraven√Ω index pro 'svalova hmota (%)' - mƒõl by b√Ωt jeden
                const muscleKgOrPercentIdx = headers.indexOf('svalova hmota (kg)') !== -1 ? headers.indexOf('svalova hmota (kg)') : headers.indexOf('svalova hmota (%)');
                
                const dateIdx = headers.indexOf('datum');
                const weightIdx = headers.indexOf('vaha (kg)');
                const fatIdx = headers.indexOf('telesny tuk (%)');
                const waterIdx = headers.indexOf('voda v tele (%)');
                const manualBmrIdx = headers.indexOf('manual bmr');
                const manualAmrIdx = headers.indexOf('manual amr');
                const notesIdx = headers.indexOf('poznamky');


                let importedCount = 0;
                let skippedCount = 0;

                for (let i = 1; i < lines.length; i++) {
                    const data = lines[i].split(',');

                    const date = data[dateIdx] ? data[dateIdx].trim() : null;
                    const weight = data[weightIdx] ? parseFloat(data[weightIdx].trim()) : null;

                    if (!date || !weight || isNaN(weight)) {
                        skippedCount++;
                        continue;
                    }
                    
                    let muscleMassKg = null;
                    if (muscleKgOrPercentIdx !== -1 && data[muscleKgOrPercentIdx] && !isNaN(parseFloat(data[muscleKgOrPercentIdx].trim()))) {
                        // Kontrola, zda hlaviƒçka indikovala procenta, a p≈ôepoƒçet na kg
                        if (headers[muscleKgOrPercentIdx] === 'svalova hmota (%)') {
                            const percent = parseFloat(data[muscleKgOrPercentIdx].trim());
                            muscleMassKg = parseFloat(((percent / 100) * weight).toFixed(2));
                        } else { // P≈ôedpokl√°d√°me, ≈æe je to ji≈æ v kg
                            muscleMassKg = parseFloat(data[muscleKgOrPercentIdx].trim());
                        }
                    }

                    const newEntry = {
                        date: date,
                        weight: weight,
                        bodyFat: fatIdx !== -1 && data[fatIdx] ? parseFloat(data[fatIdx].trim()) : null,
                        muscleMass: muscleMassKg,
                        bodyWater: waterIdx !== -1 && data[waterIdx] ? parseFloat(data[waterIdx].trim()) : null,
                        manualBMR: manualBmrIdx !== -1 && data[manualBmrIdx] ? parseInt(data[manualBmrIdx].trim()) : null,
                        manualAMR: manualAmrIdx !== -1 && data[manualAmrIdx] ? parseInt(data[manualAmrIdx].trim()) : null,
                        notes: notesIdx !== -1 && data[notesIdx] ? data[notesIdx].trim().replace(/^"|"$/g, '') : ""
                    };
                    const existingIndex = weightLog.findIndex(entry => entry.date === newEntry.date);
                    if (existingIndex !== -1) {
                        weightLog[existingIndex] = newEntry;
                    } else {
                        weightLog.push(newEntry);
                    }
                    importedCount++;
                }
                if (importedCount > 0) {
                    await saveData(); // Nyn√≠ je saveData() asynchronn√≠
                    updateDisplay();
                    showNotification(`Importov√°no ${importedCount} z√°znam≈Ø. ${skippedCount > 0 ? skippedCount + ' p≈ôeskoƒçeno.' : ''}`);
                } else {
                    showNotification('Nebyly nalezeny ≈æ√°dn√© platn√© z√°znamy k importu v CSV.', 3000);
                }
                inputElement.value = '';
            };
            reader.readAsText(file);
        }

        async function importFromBackup(inputElement) { // Zmƒõnƒõno na async
            const file = inputElement.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) { // Zmƒõnƒõno na async
                try {
                    const backupData = JSON.parse(e.target.result);
                    if (backupData.appName !== "Pokroƒçil√Ω v√°hov√Ω tracker v√≠ce admir√°la Ji≈ô√≠ka") {
                        // Nahrazeno confirm() vlastn√≠m mod√°ln√≠m oknem
                        if (!await showModalConfirm("Zd√° se, ≈æe tento soubor nepoch√°z√≠ z t√©to aplikace. P≈ôesto pokraƒçovat?")) {
                            inputElement.value = ''; return;
                        }
                    }

                    if (backupData.weightLog) weightLog = backupData.weightLog;
                    if (backupData.settings) settings = { ...settings, ...backupData.settings };
                    if (backupData.goals) goals = { ...goals, ...backupData.goals };
                    
                    weightLog.forEach(entry => {
                        if (entry.manualBMR === undefined) entry.manualBMR = null;
                        if (entry.manualAMR === undefined) entry.manualAMR = null;
                        if (entry.muscleMass === undefined) entry.muscleMass = null;
                    });

                    await saveData(); // Nyn√≠ je saveData() asynchronn√≠
                    updateForms();
                    updateDisplay();
                    showNotification('Z√°loha √∫spƒõ≈°nƒõ obnovena!');
                } catch (error) {
                    showNotification('Chyba p≈ôi naƒç√≠t√°n√≠ z√°lohy: ' + error.message, 4000);
                    console.error("Backup import error:", error);
                }
                inputElement.value = '';
            };
            reader.readAsText(file);
        }

        async function clearAllData() { // Zmƒõnƒõno na async
            // Nahrazeno confirm() vlastn√≠m mod√°ln√≠m oknem
            if (await showModalConfirm('‚ö†Ô∏è OPRAVDU chcete smazat V≈†ECHNA data? Tuto akci nelze vr√°tit zpƒõt!')) {
                // Nahrazeno confirm() vlastn√≠m mod√°ln√≠m oknem
                if (await showModalConfirm('‚ö†Ô∏è JSTE SI ABSOLUTNƒö JISTI? V≈°echna data budou nen√°vratnƒõ ztracena!')) {
                    localStorage.removeItem('weightLog_JirikTracker_v2_charts_separated_musclePercent');
                    localStorage.removeItem('weightSettings_JirikTracker_v2_charts_separated_musclePercent');
                    localStorage.removeItem('weightGoals_JirikTracker_v2_charts_separated_musclePercent');
                    
                    // Zkus√≠me smazat i ze Supabase (prozat√≠m bez ovƒõ≈ôen√≠ u≈æivatele)
                    try {
                        const { error } = await supabase.from('weight_entries').delete().neq('date', 'null'); // Sma≈æe v≈°e, kde datum nen√≠ NULL
                        if (error) {
                            console.error('Chyba p≈ôi maz√°n√≠ dat ze Supabase:', error.message);
                            showNotification('Chyba p≈ôi maz√°n√≠ dat z cloudu, sma≈æte je ruƒçnƒõ!', 5000);
                        } else {
                            console.log('Data √∫spƒõ≈°nƒõ smaz√°na ze Supabase.');
                        }
                    } catch (err) {
                        console.error('Nastala chyba p≈ôi maz√°n√≠ dat ze Supabase:', err);
                        showNotification('Chyba p≈ôi maz√°n√≠ dat z cloudu, sma≈æte je ruƒçnƒõ!', 5000);
                    }

                    weightLog = [];
                    // Reset settings a goals na v√Ωchoz√≠ hodnoty
                    settings = { height: 174, age: null, gender: 'male', activityLevel: 1.55, bmiWarningUpper: 25, bmiDangerUpper: 30, bmiWarningLower: 18.5, reminderEnabled: true, reminderInterval: 7 };
                    goals = { targetWeight: null, targetBMI: null, targetDate: null, weeklyGoal: null };
                    await loadData(); // Nyn√≠ je loadData() asynchronn√≠
                    showNotification('V≈°echna data byla smaz√°na!');
                }
            }
        }

        function checkReminders() {
            if (!settings.reminderEnabled || weightLog.length === 0) return;
            const lastEntry = [...weightLog].sort((a, b) => new Date(b.date) - new Date(a.date))[0];
            if (lastEntry) {
                const daysSinceLastEntry = Math.floor((new Date() - new Date(lastEntry.date)) / (1000 * 60 * 60 * 24));
                if (daysSinceLastEntry >= settings.reminderInterval) {
                    showNotification(`‚è∞ P≈ôipom√≠nka: Posledn√≠ z√°znam v√°hy byl p≈ôed ${daysSinceLastEntry} dny (${formatDateForDisplay(lastEntry.date)})!`, 5000);
                }
            }
        }
        setInterval(checkReminders, 30 * 60 * 1000);

        function toggleFullScreen() {
            const elem = document.documentElement;
            const btn = document.getElementById('fullscreen-btn');
            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) elem.requestFullscreen().catch(err => console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`));
                else if (elem.mozRequestFullScreen) elem.mozRequestFullScreen();
                else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
                else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
                if(btn) btn.innerHTML = '&#10006;';
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                else if (document.msExitFullscreen) elem.msExitFullscreen();
                if(btn) btn.innerHTML = '&#x26F6;';
            }
        }
        
        function updateFullscreenButtonIcon() {
            const btn = document.getElementById('fullscreen-btn');
            if(!btn) return;
            if (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement) {
                btn.innerHTML = '&#10006;';
            } else {
                btn.innerHTML = '&#x26F6;';
            }
        }

        // !!! HLAVN√ç ZMƒöNA: refreshAllData() nyn√≠ vol√° asynchronn√≠ loadData() !!!
        async function refreshAllData() {
            // Nejd≈ô√≠ve zniƒç√≠me existuj√≠c√≠ instance graf≈Ø, ne≈æ je znovu inicializujeme
            if (weightChart) weightChart.destroy();
            if (bmiChart) bmiChart.destroy();
            if (bodyFatOnlyChart) bodyFatOnlyChart.destroy();
            if (muscleMassOnlyChart) muscleMassOnlyChart.destroy();
            if (bodyWaterChart) bodyWaterChart.destroy();
            if (manualBMRChart) manualBMRChart.destroy();
            if (manualAMRChart) manualAMRChart.destroy();

            await loadData(); // Nyn√≠ ƒçek√°me na dokonƒçen√≠ naƒç√≠t√°n√≠ dat ze Supabase
            updateForms(); // Aktualizuje formul√°≈ôe s naƒçten√Ωmi daty
            initializeCharts(); // Nyn√≠ se grafy inicializuj√≠ na "ƒçist√Ωch" pl√°tnech
            updateDisplay(); // Aktualizuje zobrazen√≠ tabulky, graf≈Ø, statistik a doporuƒçen√≠
            checkReminders(); // Zkontroluje p≈ôipom√≠nky
            showNotification('V≈°echny √∫daje byly √∫spƒõ≈°nƒõ aktualizov√°ny (vƒçetnƒõ cloudu)!', 3000);
        }

        // !!! D≈ÆLE≈ΩIT√â ZMƒöNA: window.onload ... je nyn√≠ asynchronn√≠ !!!
        // Cel√Ω n√°≈° hlavn√≠ k√≥d se spust√≠ a≈æ po naƒçten√≠ cel√© str√°nky
        window.onload = async function () { // P≈ôid√°no 'async'
            // Inicializace Supabase klienta uvnit≈ô window.onload
            // V tomto bodƒõ by mƒõl b√Ωt glob√°ln√≠ objekt Supabase zaruƒçenƒõ dostupn√Ω
            console.log("window.onload spu≈°tƒõn.");
            console.log("Typ Supabase p≈ôed inicializac√≠:", typeof Supabase); // Diagnostick√° zpr√°va

            supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log("Supabase klient inicializov√°n."); // Diagnostick√° zpr√°va


            await loadData(); // Nyn√≠ ƒçek√°me na dokonƒçen√≠ naƒç√≠t√°n√≠ dat ze Supabase/LocalStorage
            initializeCharts();
            updateDisplay();
            checkReminders();
            setTodayDate();

            // P≈ôid√°n√≠ tlaƒç√≠tka na celou obrazovku
            const fullscreenButton = document.createElement('button');
            fullscreenButton.className = 'fullscreen';
            fullscreenButton.id = 'fullscreen-btn';
            fullscreenButton.innerHTML = '&#x26F6;';
            fullscreenButton.title = 'P≈ôepnout na celou obrazovku';
            fullscreenButton.addEventListener('click', toggleFullScreen);
            document.body.appendChild(fullscreenButton);

            ['fullscreenchange', 'mozfullscreenchange', 'webkitfullscreenchange', 'msfullscreenchange'].forEach(event =>
                document.addEventListener(event, updateFullscreenButtonIcon)
            );
        };
    </script>
</body>
</html>
 